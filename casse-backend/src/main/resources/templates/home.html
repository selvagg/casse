<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<div class="main-content-wrapper">
    <div>
        <h1>Welcome, <span th:text="${name}"></span>!</h1>
    </div>
    <div class="container-small">
        <form th:action="@{/logout}" method="post">
            <button type="submit" class="logout-button">Logout</button>
        </form>
    </div>
    <div class="spacer"></div>

    <!-- Container for the upload form (Song metadata + File Upload) -->
    <div class="container">
        <h1>Upload Song for Approval</h1>
        <form th:action="@{/audio/upload}" th:object="${song}" method="post" enctype="multipart/form-data">
            <div>
                <label for="title">Title:</label>
                <input type="text" id="title" th:field="*{title}" required/>
            </div>
            <div>
                <label for="artists">Artists:</label>
                <input type="text" id="artists" th:field="*{artists}" required/>
            </div>
            <div>
                <label for="album">Album:</label>
                <input type="text" id="album" th:field="*{album}"/>
            </div>
            <div>
                <label for="composer">Composer:</label>
                <input type="text" id="composer" th:field="*{composer}"/>
            </div>
            <div>
                <label for="tags">Tags:</label>
                <input type="text" id="tags" th:field="*{tags}"/>
            </div>
            <div>
                <label for="audioFile">Audio File:</label>
                <input type="file" id="audioFile" name="file" accept="audio/*" required/>
            </div>
            <div>
                <label for="albumArt">Album Art:</label>
                <input type="file" id="albumArt" name="albumArt" accept="image/*"/>
            </div>
            <button type="submit">Submit for Approval</button>
        </form>
    </div>

    <div class="spacer"></div>

    <!-- Song list above the Stream Audio section -->
    <div class="container">
        <h2>Available Songs</h2>
        <ul class="song-list" id="songList">
            <!-- List of songs will be dynamically populated here -->
        </ul>
    </div>

    <div class="spacer"></div>

    <!-- Container for the streaming section -->
    <div class="container">
        <h2>Stream Audio</h2>
        <input type="text" id="fileName" placeholder="Enter filename">
        <button onclick="playAudio()">Play</button>
    </div>

    <div class="spacer"></div>

    <!-- Audio player -->
    <audio id="audioPlayer" controls></audio>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const userName = /*[[${name}]]*/ 'default-user';
    /*]]>*/

    // Function to fetch and display the list of songs
    async function fetchSongList() {
        try {
            let response = await fetch("/audio/list");
            if (response.ok) {
                let songs = await response.json();
                let songListElement = document.getElementById("songList");
                songListElement.innerHTML = ''; // Clear any previous list

                songs.forEach(song => {
                    let listItem = document.createElement("li");

                    let albumArt = document.createElement("img");
                    albumArt.src = song.albumArt;
                    albumArt.style.width = "50px";
                    albumArt.style.height = "50px";
                    listItem.appendChild(albumArt);

                    let songTitle = document.createElement("span");
                    songTitle.textContent = song.title;
                    listItem.appendChild(songTitle);

                    listItem.onclick = () => {
                        document.getElementById("fileName").value = song.storageAccessKey; // Set the filename to be streamed
                    };
                    songListElement.appendChild(listItem);
                });
            } else {
                console.error("Error fetching song list.");
            }
        } catch (error) {
            console.error("Error fetching song list:", error);
        }
    }

    function playAudio() {
        let fileName = document.getElementById("fileName").value;
        if (!fileName) {
            alert("Please enter a filename.");
            return;
        }

        let audioPlayer = document.getElementById("audioPlayer");
        audioPlayer.src = `/audio/stream-direct/${fileName}`;
        audioPlayer.play();
    }

    // Fetch the song list when the page loads
    window.onload = fetchSongList;
</script>

</body>
</html>
